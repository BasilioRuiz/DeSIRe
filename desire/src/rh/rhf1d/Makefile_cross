## ------- file: ------------------------- Makefile ----------------- ##
#
#      Version:       rh2.0, 1-D plane-parallel
#      Author:        Han Uitenbroek (huitenbroek@nso.edu)
#      Last modified: Mon May 21 14:30:59 2018 --
#
#      Updates (epm): Adaptation to the DeSIRe project (obsolete).
#                     Interoperability C-Fortran.
#                     Conversion of main() as a function for Fortran.
#                     Creation of a library containing the executables
#                     as functions and the modules they need.
#
##     --------------------------                      ----------RH-- ##

GEOMETRY = ONE_D_PLANE
CPU = x86_64
OS = Linux
include ../makefiles/makefile.$(CPU).$(OS)


## --- If no FORTRAN compiler is available remove -lrh_f90 in following

      LIBS = -lrh -lrh_f90 $(ARCHLIBS)


## --- Define groups of object files --                -------------- ##

ONE_D_OBJS = rhf1d.o \
             anglequad.o  bezier.o feautrier.o  formal.o  hydrostat.o \
             multiatmos.o \
             piecestokes.o  piecewise.o  project.o  riiplane.o \
             writeflux_xdr.o  writegeom_xdr.o

ONE_D_OBJSbrc = anglequad.o  bezier.o feautrier.o  formal.o  hydrostat.o \
             multiatmos.o \
             conversion.o  piecestokes.o  piecewise.o  project.o  riiplane.o \
             writeflux_xdr.o  writegeom_xdr.o

   ONEDOBJ = solve1d.o  iter_1d.o  feautrier.o

  RAY_OBJS = anglequad.o  bezier.o  feautrier.o  formal.o  hydrostat.o \
             multiatmos.o \
             project.o  piecestokes.o  piecewise.o  riiplane.o  solveray.o

BACKGROPAC = anglequad.o  backgrcontr.o  multiatmos.o  project.o

# Modules with cross-references.
# 15/05/19 epm: Los siguientes modulos provocan una dependencia circular ya
# que la libreria "librh.a" hace referencia a estos modulos, y estos modulos,
# a su vez, hacen referencia a la libreria. Por ejemplo:
# - iterate.c(librh.a): referencia a Hydrostatic de rhf1d/hydrostatic.c
# - rhf1d/hydrostatic.c: referencia a FMetals de nemetals.c(librh.a)
CROSS_MODULES = formal.o  hydrostat.o  riiplane.o
# Modules to include in the library "librhf1d.a" to be used from Fortran.
RHF1D_MODULES = rhf1d.o \
                anglequad.o \
                bezier.o \
                feautrier.o \
                multiatmos.o \
                piecestokes.o \
                piecewise.o \
                project.o \
                writeflux_xdr.o \
                writegeom_xdr.o


## --- Rules for the executables --                    -------------- ##
## --- and the interoperability library --             -------------- ##

all:   rhf1d  solve1d  solveray  backgrcontr  conversion  librhf1d.a

rhf1d:  $(ONE_D_OBJS)  librh
	$(LD) -o $@ rhf1d_main.o  $(LDFLAGS) $(ONE_D_OBJS) $(LIBS)

solve1d:  $(ONEDOBJ)  librh
	$(LD) -o $@  $(LDFLAGS) $(ONEDOBJ) $(LIBS)

solveray:  $(RAY_OBJS)  librh
	$(LD) -o $@  $(LDFLAGS) $(RAY_OBJS) $(LIBS)

backgrcontr:  $(BACKGROPAC) librh
	$(LD) -o $@  $(LDFLAGS) $(BACKGROPAC) $(LIBS)

conversion: $(ONE_D_OBJSbrc)  librh
	$(LD) -o $@  $(LDFLAGS) $(ONE_D_OBJSbrc) $(LIBS)

librhf1d.a: $(RHF1D_MODULES)
	ar $(ARFLAGS) $@ $(RHF1D_MODULES)


## --- If no FORTRAN compiler is available remove librh_f90.a in following

librh:
	cd ..; $(MAKE) librh.a  librh_f90.a


## --- Clean up --                                     -------------- ##

clean:
	rm -f *.o  rhf1d  solve1d  solveray  backgrcontr  conversion


## --- Explicit dependencies on include files --       -------------- ##


anglequad.o:            ../rh.h  ../atom.h  ../atmos.h  \
                        geometry.h

bezier.o:               ../rh.h  ../atom.h  ../atmos.h       \
                        geometry.h  ../spectrum.h    bezier.h

backgrcontr.o:          ../rh.h  ../atom.h  ../atmos.h  \
                        ../spectrum.h  geometry.h  ../background.h  \
                        ../inputs.h  ../error.h  ../statistics.h


conversion.o:           ../rh.h  ../atom.h  ../atmos.h  \
                        geometry.h  ../spectrum.h  ../background.h  \
                        ../statistics.h  ../error.h  ../inputs.h  ../xdr.h


feautrier.o:            ../rh.h  ../atom.h  ../atmos.h  \
                        geometry.h  ../spectrum.h  ../error.h

formal.o:               ../rh.h  ../atom.h  ../atmos.h  \
                        geometry.h  ../spectrum.h  ../constant.h  \
                        ../background.h  ../inputs.h  ../error.h  ../xdr.h

hydrostat.o:            ../rh.h  ../atom.h  ../atmos.h  geometry.h \
                        ../background.h  ../constant.h  ../accelerate.h \
                        ../error.h

iter_1d.o:              ../rh.h  ../atom.h  ../atmos.h  \
                        geometry.h  ../accelerate.h  ../error.h  \
                        ../statistics.h

multiatmos.o:           ../rh.h  ../atom.h  ../atmos.h  \
                        geometry.h  ../spectrum.h  ../background.h  \
                        ../constant.h  ../error.h  ../inputs.h  \
                        ../statistics.h  ../xdr.h

piecestokes.o:          ../rh.h  ../error.h  ../atom.h  ../atmos.h  \
                        geometry.h  ../spectrum.h

piecewise.o:            ../rh.h  ../error.h  ../atom.h  ../atmos.h  \
                        geometry.h  ../spectrum.h

project.o:              ../rh.h  ../atom.h  ../atmos.h  \
                        geometry.h

rhf1d.o:                ../rh.h  ../atom.h  ../atmos.h  \
                        geometry.h  ../spectrum.h  ../background.h  \
                        ../statistics.h  ../error.h  ../inputs.h  ../xdr.h

riiplane.o:             ../rh.h  ../atom.h  ../atmos.h  \
                        geometry.h  ../constant.h  ../error.h

solve1d.o:              ../rh.h  ../atom.h  ../atmos.h  \
                        geometry.h  ../spectrum.h  ../accelerate.h  \
                        ../constant.h  ../statistics.h  ../inputs.h

solveray.o:             ../rh.h  ../atom.h  ../atmos.h  \
                        geometry.h  ../spectrum.h  ../background.h  \
                        ../statistics.h  ../inputs.h  ../error.h  ../xdr.h

writeflux_xdr.o:        ../rh.h  ../atom.h  ../atmos.h  \
                        geometry.h  ../spectrum.h  ../constant.h  \
                        ../error.h  ../xdr.h

writegeom_xdr.o:        ../rh.h  ../atom.h  ../atmos.h  \
                        geometry.h  ../error.h  ../inputs.h  ../xdr.h

## ------- end ---------------------------- Makefile ---------------- ##
